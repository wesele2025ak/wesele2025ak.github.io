<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prześlij zdjęcie — live</title>
<style>
  :root{color-scheme:dark}
  body{font-family:system-ui, sans-serif;margin:0;padding:16px;background:#0b0c10;color:#e8e8e8}
  .card{max-width:900px;margin:0 auto;background:#121317;border:1px solid #23242a;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  h1{font-size:1.15rem;margin:0 0 8px}
  .muted{color:#a7a7a7;font-size:.95rem}
  .status{margin-top:10px;padding:10px;border-radius:8px;background:#0e1116;border:1px solid #1f2530;white-space:pre-wrap;min-height:3em}
  .ok{border-color:#2a5}.err{border-color:#d55}
  .metaRow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
  .controlsBar{display:flex;gap:8px;align-items:center}
  button{font:inherit;background:#1f88ff;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .pill{display:inline-block;border:1px dashed #2b2e36;padding:6px 10px;border-radius:999px;font-size:.85rem;color:#bbc}
  .videoWrap{margin-top:12px;position:relative;border-radius:12px;overflow:hidden;background:#000;min-height:260px;display:none}
  video{width:100%;height:auto;display:block;background:#000;transform-origin:center center}
  .overlays{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
  .control{position:absolute;pointer-events:auto;background:rgba(20,22,26,.55);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;border-radius:999px;padding:8px;cursor:pointer;color:#fff}
  .control svg{width:20px;height:20px;display:block}
  .control.small{width:44px;height:44px}
  .control.big{width:72px;height:72px;background:linear-gradient(180deg,#2a86ff,#1a6fe0);box-shadow:0 6px 18px rgba(25,110,220,.25)}
  .control.topRight{top:12px;right:12px}
  .control.bottomCenter{left:50%;transform:translateX(-50%);bottom:18px}
  .control.bottomRight{right:20px;bottom:16px}
  .hint{margin-top:8px;font-size:.9rem;color:#cfcfcf}
  .inApp{margin-top:8px;padding:8px;background:#16181b;border:1px solid #2a2d33;border-radius:8px}
  input[type=file]{position:absolute;left:-9999px}
  .flash{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;background:rgba(255,255,255,0);opacity:0;transition:opacity .18s ease;mix-blend-mode:screen;z-index:9999}
  .flash.do{opacity:0.85;background:white;transition:opacity .18s ease}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:10px 16px;border-radius:10px;background:rgba(20,20,20,0.92);color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.5);font-weight:600;z-index:9999;display:none}
  .toast.show{display:block;animation:toast-in .22s ease}
  @keyframes toast-in{from{transform:translateX(-50%) translateY(8px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
  .progressOverlay{position:absolute;top:12px;left:50%;transform:translateX(-50%);width:64%;max-width:520px;z-index:6;pointer-events:none;display:flex;flex-direction:column;gap:8px;align-items:stretch;opacity:0;transition:opacity .15s linear}
  .progressOverlay.visible{opacity:1}
  .progressWrap{height:10px;background:rgba(20,21,24,.6);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.04);flex:1;min-width:120px}
  .progressBar{height:100%;width:0%;background:#1f88ff;transition:width .12s linear}
  .progressRowInner{display:flex;align-items:center;gap:8px}
  .progressText{font-size:.85rem;color:#cfcfcf;min-width:36px;text-align:right}
  .progressMessage{font-size:.85rem;color:#bff7c6;text-align:center}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="card">
    <h1>Dodaj zdjęcie — podgląd live</h1>
    <div class="muted" id="eventInfo">Sprawdzam token...</div>
    <div class="status" id="statusBox">Gotowy.</div>
    <div style="height:10px"></div>
    <div class="metaRow">
      <span class="pill" id="uuidInfo">UUID: …</span>
      <div class="controlsBar">
        <div id="openBtnWrap"><button id="openBtn">Uruchom kamerę</button></div>
        <button id="retryPermBtn">Sprawdź uprawnienia</button>
        <button id="openInBrowserBtn" style="display:none">Otwórz w przeglądarce</button>
        <input id="file" type="file" accept="image/*" capture="environment" />
      </div>
    </div>
    <div class="videoWrap" id="videoWrap" aria-hidden="true">
      <video id="camVid" autoplay playsinline muted></video>
      <div class="overlays" id="overlays">
        <div class="progressOverlay" id="progressOverlay" aria-hidden="true">
          <div class="progressRowInner">
            <div class="progressWrap"><div class="progressBar" id="progressBar"></div></div>
            <div class="progressText" id="progressText">…</div>
          </div>
          <div class="progressMessage" id="progressMessage" aria-live="polite"></div>
        </div>
        <button class="control topRight small" id="fsBtn" aria-label="Pełny ekran" title="Pełny ekran">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3H5a2 2 0 0 0-2 2v4"/><path d="M15 21h4a2 2 0 0 0 2-2v-4"/><path d="M21 9V5a2 2 0 0 0-2-2h-4"/><path d="M3 15v4a2 2 0 0 0 2 2h4"/></svg>
        </button>
        <button class="control bottomCenter big" id="captureBtn" aria-label="Zrób zdjęcie" title="Zrób zdjęcie">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="14" rx="2"/><circle cx="12" cy="11" r="3.4" fill="rgba(255,255,255,0.08)"/></svg>
        </button>
        <button class="control bottomRight small" id="switchBtn" aria-label="Przełącz kamerę" title="Przełącz kamerę">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h4"/><path d="M3 7v4"/><path d="M21 17h-4"/><path d="M21 17v-4"/><path d="M7 7a6 6 0 0 1 10 6"/></svg>
        </button>
      </div>
    </div>
    <div class="hint" id="hintBox">Naciśnij "Uruchom kamerę", następnie przycisk na środku, aby zrobić zdjęcie. Możesz przełączać kamery i wejść w pełny ekran.</div>
    <div class="inApp" id="inAppBox" style="display:none"></div>
  </div>
  <div class="flash" id="flash"></div>
  <div class="toast" id="toast">Wysłano</div>
<script>
(function(){
  "use strict";
  const WORKER_URL = 'https://wesele-worker.wesele2025ak.workers.dev/upload';
  const qs = new URLSearchParams(location.search);
  const eventToken = qs.get('event') || '';
  const t = qs.get('t') || '';
  const statusBox = document.getElementById('statusBox');
  const eventInfo = document.getElementById('eventInfo');
  const uuidInfo = document.getElementById('uuidInfo');
  const openBtn = document.getElementById('openBtn');
  const switchBtn = document.getElementById('switchBtn');
  const retryPermBtn = document.getElementById('retryPermBtn');
  const openInBrowserBtn = document.getElementById('openInBrowserBtn');
  const fileInput = document.getElementById('file');
  const camVid = document.getElementById('camVid');
  const videoWrap = document.getElementById('videoWrap');
  const captureBtn = document.getElementById('captureBtn');
  const hintBox = document.getElementById('hintBox');
  const inAppBox = document.getElementById('inAppBox');
  const flashEl = document.getElementById('flash');
  const toast = document.getElementById('toast');
  const fsBtn = document.getElementById('fsBtn');
  const progressOverlay = document.getElementById('progressOverlay');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressMessage = document.getElementById('progressMessage');
  function setOk(m){ statusBox.classList.remove('err'); statusBox.classList.add('ok'); statusBox.textContent = m; }
  function setErr(m){ statusBox.classList.remove('ok'); statusBox.classList.add('err'); statusBox.textContent = m; }
  if(!eventToken || !t){ setErr('Brak parametrów ?event= i ?t= w linku. Użyj prawidłowego QR.'); } else { eventInfo.textContent = `Wydarzenie: ${eventToken}`; }
  const memoryStore = {};
  const safeStorage = { get(k){ try{ return localStorage.getItem(k)}catch(e){return memoryStore[k]??null}}, set(k,v){ try{ localStorage.setItem(k,v)}catch(e){ memoryStore[k]=String(v)}}};
  function makeUUID(){
    if (typeof crypto !== 'undefined' && crypto.randomUUID) try{ return crypto.randomUUID(); } catch(e){}
    if (typeof crypto !== 'undefined' && crypto.getRandomValues){
      const b=new Uint8Array(16);crypto.getRandomValues(b);b[6]=(b[6]&0x0f)|0x40;b[8]=(b[8]&0x3f)|0x80;const h=[...b].map(x=>x.toString(16).padStart(2,'0')).join('');return `${h.slice(0,8)}-${h.slice(8,12)}-${h.slice(12,16)}-${h.slice(16,20)}-${h.slice(20)}`;
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});
  }
  const UUID_KEY = 'qrphoto_uuid';
  let uuid = safeStorage.get(UUID_KEY);
  if(!uuid){ uuid = makeUUID(); safeStorage.set(UUID_KEY, uuid); }
  uuidInfo.textContent = 'UUID: ' + uuid;
  function detectInApp(){
    const ua = navigator.userAgent || navigator.vendor || '';
    const tests = ['FBAN','FBAV','Instagram','Line','Twitter','LinkedInApp','Vkontakte','Telegram','WhatsApp'];
    for(const t of tests) if(ua.indexOf(t)!==-1) return t;
    return null;
  }
  const inApp = detectInApp();
  if(inApp){ inAppBox.style.display='block'; inAppBox.innerHTML = `<strong>Wygląda na wbudowaną przeglądarkę (${inApp}).</strong> Jeśli kamera nie działa, kliknij "Otwórz w przeglądarce".`; openInBrowserBtn.style.display='inline-block'; }
  window.addEventListener('error',(e)=> setErr('Błąd skryptu: '+(e.message||'nieznany')));
  window.addEventListener('unhandledrejection',(e)=> setErr('Błąd obietnicy: '+(e.reason && e.reason.message || 'nieznany')));
  let activeStream = null;
  let uploading = false;
  let currentFacing = 'environment';
  let switching = false;
  let freezeTimer = null;
  let lastVideoTime = 0;
  function doFlash(){ flashEl.classList.add('do'); setTimeout(()=> flashEl.classList.remove('do'), 180); }
  function showToast(m){ toast.textContent = m; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 2200); }
  async function checkPermissionState(){ if(!navigator.permissions || !navigator.permissions.query) return null; try{ const p = await navigator.permissions.query({ name: 'camera' }); return p.state; } catch(e){ return null; } }
  function startFreezeWatcher(){
    lastVideoTime = camVid.currentTime || 0;
    if(freezeTimer) clearInterval(freezeTimer);
    freezeTimer = setInterval(()=>{
      const now = camVid.currentTime || 0;
      if(now === lastVideoTime){
        if(typeof lastVideoTime === 'number'){ lastVideoTime = { frozenSince: Date.now(), last: lastVideoTime }; }
        else if(lastVideoTime && (Date.now() - lastVideoTime.frozenSince) > 1500){ handleCameraFreeze(); }
      } else { lastVideoTime = now; }
    }, 500);
  }
  function stopFreezeWatcher(){ if(freezeTimer){ clearInterval(freezeTimer); freezeTimer = null; lastVideoTime = 0; } }
  function handleCameraFreeze(){ stopCamera(); setErr('Podgląd kamery uległ zacięciu — podgląd wyłączony. Użyj przycisku aby ponownie uruchomić kamerę.'); videoWrap.style.display = 'none'; }
  async function getDeviceIdForFacing(facing){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=>d.kind==='videoinput');
      if(!vids.length) return null;
      const labelsAvailable = vids.every(d=>!!d.label);
      if(labelsAvailable){
        const needle = facing === 'user' ? ['front','user','face'] : ['back','rear','environment'];
        for(const n of needle){ const found = vids.find(v=>v.label.toLowerCase().indexOf(n)!==-1); if(found) return found.deviceId; }
      }
      return facing === 'user' ? vids[0].deviceId : vids[vids.length-1].deviceId;
    }catch(e){ return null; }
  }
  async function tryGetStream(facing){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return null;
    try{ return await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ exact:facing }, width:{ ideal:1920 }, height:{ ideal:1080 } }, audio:false }); }catch(e1){}
    try{ return await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:facing }, width:{ ideal:1920 }, height:{ ideal:1080 } }, audio:false }); }catch(e2){}
    const deviceId = await getDeviceIdForFacing(facing);
    if(deviceId){
      try{ return await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact:deviceId }, width:{ ideal:1920 }, height:{ ideal:1080 } }, audio:false }); }catch(e3){}
    }
    return null;
  }
  async function startCamera(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ setErr('getUserMedia niedostępny (webview lub stara przeglądarka).'); fileInput.click(); return; }
    setOk('Proszę o dostęp do kamery...');
    try{
      stopCamera();
      const stream = await tryGetStream(currentFacing);
      if(!stream){ providePermissionHelp(new Error('Nie można uzyskać strumienia dla tej kamery')); return; }
      activeStream = stream;
      camVid.srcObject = stream;
      camVid.playsInline = true;
      videoWrap.style.display = 'block';
      await camVid.play().catch(()=>{});
      setOk('Kamera uruchomiona — naciśnij centralny przycisk, aby zrobić zdjęcie.');
      hintBox.textContent = 'Naciśnij środkowy przycisk, aby zrobić zdjęcie. Możesz przełączać kamery i wejść w pełny ekran.';
      startFreezeWatcher();
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        if(vids.length){}
      }catch(e){}
    }catch(err){
      providePermissionHelp(err);
    }
  }
  function stopCamera(){ stopFreezeWatcher(); if(activeStream){ activeStream.getTracks().forEach(t=>t.stop()); activeStream = null; } try{ camVid.srcObject = null; }catch(e){} videoWrap.style.display = 'none'; }
  function needRotateForDevice(origW, origH){ const deviceLandscape = window.innerWidth > window.innerHeight; const videoLandscape = origW > origH; return deviceLandscape !== videoLandscape; }
  function rotateCanvas90(srcCanvas, clockwise){ const sW = srcCanvas.width; const sH = srcCanvas.height; const dst = document.createElement('canvas'); dst.width = sH; dst.height = sW; const ctx = dst.getContext('2d'); if(clockwise){ ctx.translate(dst.width,0); ctx.rotate(Math.PI/2); ctx.drawImage(srcCanvas,0,0); } else { ctx.translate(0,dst.height); ctx.rotate(-Math.PI/2); ctx.drawImage(srcCanvas,0,0); } return dst; }
  let indeterminateTimer = null;
  function startIndeterminateProgress(){
    stopIndeterminateProgress();
    let pct = 8;
    progressOverlay.classList.add('visible');
    progressBar.style.width = pct + '%';
    progressText.textContent = pct + '%';
    progressMessage.textContent = '';
    indeterminateTimer = setInterval(()=>{
      pct = pct + (Math.random() * 6 + 2);
      if(pct > 88) pct = 60 + Math.random() * 20;
      progressBar.style.width = Math.min(90, Math.round(pct)) + '%';
      progressText.textContent = Math.min(90, Math.round(pct)) + '%';
    }, 220);
  }
  function stopIndeterminateProgress(){ if(indeterminateTimer){ clearInterval(indeterminateTimer); indeterminateTimer = null; } }
  let audioCtx = null;
  function playShutter(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
      const now = audioCtx.currentTime;
      const master = audioCtx.createGain(); master.gain.value = 0.45; master.connect(audioCtx.destination);
      const noiseLen = Math.floor(audioCtx.sampleRate * 0.05);
      const noiseBuf = audioCtx.createBuffer(1, noiseLen, audioCtx.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for(let i=0;i<noiseLen;i++){ data[i] = (Math.random()*2-1) * Math.pow(1 - i/noiseLen, 2) * 0.6; }
      const nb = audioCtx.createBufferSource(); nb.buffer = noiseBuf;
      const ng = audioCtx.createGain(); ng.gain.setValueAtTime(0.9, now); ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);
      nb.connect(ng); ng.connect(master);
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(950, now);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.28, now + 0.003); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
      osc.connect(g); g.connect(master);
      nb.start(now); nb.stop(now + 0.09); osc.start(now); osc.stop(now + 0.09);
    }catch(e){}
  }
  async function captureAndUpload(){
    if(uploading) return;
    if(!camVid || camVid.readyState < 2){ setErr('Kamera niegotowa.'); return; }
    uploading = true;
    captureBtn.disabled = true;
    doFlash();
    playShutter();
    const rawW = camVid.videoWidth || 1280;
    const rawH = camVid.videoHeight || 720;
    const tmp = document.createElement('canvas');
    tmp.width = rawW;
    tmp.height = rawH;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(camVid, 0, 0, rawW, rawH);
    let finalCanvas = tmp;
    if(needRotateForDevice(rawW, rawH)) finalCanvas = rotateCanvas90(tmp, true);
    finalCanvas.toBlob(async (blob)=>{
      if(!blob){ setErr('Nie udało się przygotować zdjęcia'); uploading=false; captureBtn.disabled=false; progressOverlay.classList.remove('visible'); return; }
      const file = new File([blob],'photo.jpg',{type:'image/jpeg'});
      try{
        await uploadFileWithProgress(file);
        setOk('Wysłano ✅');
        progressMessage.textContent = 'Wysłano';
        showToast('Wysłano');
        setTimeout(()=>{ progressOverlay.classList.remove('visible'); progressMessage.textContent = ''; }, 1200);
      }catch(e){
        progressMessage.textContent = 'Błąd wysyłania';
        setErr('Błąd wysyłania');
        setTimeout(()=>{ progressOverlay.classList.remove('visible'); progressMessage.textContent = ''; }, 2000);
      }finally{
        uploading = false;
        captureBtn.disabled = false;
        progressBar.style.width = '0%';
        progressText.textContent = '…';
        stopIndeterminateProgress();
      }
    }, 'image/jpeg', 0.92);
  }
  function uploadFileWithProgress(file){
    progressMessage.textContent = '';
    startIndeterminateProgress();
    return new Promise((res, rej)=>{
      const fd = new FormData();
      fd.append('file', file, file.name || 'photo.jpg');
      fd.append('event', eventToken);
      fd.append('uuid', uuid);
      fd.append('t', t);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', WORKER_URL, true);
      xhr.timeout = 40000;
      let seenReal = false;
      xhr.upload.onprogress = (e)=>{
        if(e.lengthComputable){
          if(!seenReal){ seenReal = true; stopIndeterminateProgress(); }
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = pct + '%';
          progressText.textContent = pct + '%';
        } else {
          if(!indeterminateTimer) startIndeterminateProgress();
        }
      };
      xhr.onload = ()=>{
        stopIndeterminateProgress();
        let json = {};
        try{ json = JSON.parse(xhr.responseText || '{}'); }catch(e){}
        if(xhr.status>=200 && xhr.status<300){
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          progressMessage.textContent = 'Sukces';
          setTimeout(()=>{ progressMessage.textContent = 'Wysłano'; }, 300);
          setTimeout(()=>{ res(json); }, 500);
        } else {
          progressMessage.textContent = 'Błąd';
          rej(json);
        }
      };
      xhr.onerror = ()=>{ stopIndeterminateProgress(); progressMessage.textContent = 'Błąd sieci'; rej(new Error('network')); };
      xhr.ontimeout = ()=>{ stopIndeterminateProgress(); progressMessage.textContent = 'Timeout'; rej(new Error('timeout')); };
      try{ xhr.send(fd); }catch(e){ stopIndeterminateProgress(); progressMessage.textContent = 'Błąd wysyłania'; rej(e); }
    });
  }
  fileInput.addEventListener('change', async ()=>{
    const f = fileInput.files && fileInput.files[0];
    if(!f){ setErr('Brak pliku'); return; }
    setOk('Wybrano plik — wysyłam...');
    try{ await uploadFileWithProgress(f); setOk('Wysłano ✅'); showToast('Wysłano'); setTimeout(()=>{ progressOverlay.classList.remove('visible'); progressMessage.textContent = ''; }, 1200); }catch(e){ setErr('Błąd uploadu'); setTimeout(()=>{ progressOverlay.classList.remove('visible'); progressMessage.textContent = ''; }, 1600); }finally{ progressBar.style.width='0%'; progressText.textContent='…'; stopIndeterminateProgress(); }
  });
  document.getElementById('openBtn').addEventListener('click', async ()=>{ await startCamera(); });
  captureBtn.addEventListener('click', captureAndUpload);
  switchBtn.addEventListener('click', async ()=>{
    if(switching) return;
    switching = true;
    try{ currentFacing = currentFacing === 'environment' ? 'user' : 'environment'; await startCamera(); }finally{ switching = false; }
  });
  retryPermBtn.addEventListener('click', async ()=>{
    setOk('Sprawdzam stan uprawnień...');
    const state = await checkPermissionState();
    if(state === 'granted'){ setOk('Uprawnienia przyznane — uruchamiam kamerę...'); await startCamera(); return; }
    if(state === 'prompt' || state === null){ setOk('Spróbuję ponownie poprosić o dostęp...'); await startCamera(); return; }
    if(state === 'denied'){ setErr('Uprawnienie zablokowane. Zobacz instrukcje w polu poniżej.'); showPermissionInstructions(); return; }
    setErr('Nie można sprawdzić uprawnień — spróbuj ręcznie w ustawieniach lub otwórz w innej przeglądarce.');
  });
  async function checkPermissionState(){ if(!navigator.permissions || !navigator.permissions.query) return null; try{ const p = await navigator.permissions.query({ name: 'camera' }); return p.state; } catch(e){ return null; } }
  function providePermissionHelp(err){ const msg = err && err.name ? err.name : String(err); setErr('Dostęp do kamery odrzucony lub zablokowany: ' + msg + '\nZobacz instrukcje poniżej.'); showPermissionInstructions(); }
  function showPermissionInstructions(){ inAppBox.style.display='block'; inAppBox.innerHTML = `<strong>Jak odblokować kamerę?</strong>
      <ol>
        <li>Jeśli jesteś w aplikacji (Facebook/Instagram) — wybierz "Otwórz w przeglądarce" i spróbuj ponownie.</li>
        <li>iOS: Ustawienia → Safari (lub inna przeglądarka) → Kamera → Zezwól.</li>
        <li>Android: Ustawienia → Aplikacje → Chrome (lub inna) → Uprawnienia → Kamera → Zezwól.</li>
        <li>Możesz też usunąć blokadę dla tej strony w ustawieniach witryny (Site settings → Camera).</li>
      </ol>
      Po zmianie ustawień wróć tutaj i naciśnij "Sprawdź uprawnienia".`; }
  openInBrowserBtn.addEventListener('click', ()=>{ window.open(location.href, '_blank', 'noopener'); });
  window.addEventListener('pagehide', ()=>{ if(activeStream) activeStream.getTracks().forEach(t=>t.stop()); });
  fsBtn.addEventListener('click', async ()=>{ try{ if(!document.fullscreenElement) await videoWrap.requestFullscreen(); else await document.exitFullscreen(); }catch(e){} });
  document.addEventListener('fullscreenchange', ()=>{});
})();
</script>
</body>
</html>
